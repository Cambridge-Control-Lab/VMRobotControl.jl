<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Using a mechanism · VMRobotControl.jl</title><meta name="title" content="Using a mechanism · VMRobotControl.jl"/><meta property="og:title" content="Using a mechanism · VMRobotControl.jl"/><meta property="twitter:title" content="Using a mechanism · VMRobotControl.jl"/><meta name="description" content="Documentation for VMRobotControl.jl."/><meta property="og:description" content="Documentation for VMRobotControl.jl."/><meta property="twitter:description" content="Documentation for VMRobotControl.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">VMRobotControl.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../introduction/">Introduction</a></li><li><a class="tocitem" href="../building/">Building a mechanism</a></li><li class="is-active"><a class="tocitem" href>Using a mechanism</a><ul class="internal"><li><a class="tocitem" href="#Compiling"><span>Compiling</span></a></li><li><a class="tocitem" href="#Caches-and-&quot;Cache-Bundles&quot;"><span>Caches and &quot;Cache-Bundles&quot;</span></a></li><li><a class="tocitem" href="#Accessing-results"><span>Accessing results</span></a></li><li><a class="tocitem" href="#Coordinate-computations"><span>Coordinate computations</span></a></li><li><a class="tocitem" href="#Component-computations"><span>Component computations</span></a></li><li><a class="tocitem" href="#Modifying-a-compiled-mechanism"><span>Modifying a compiled mechanism</span></a></li></ul></li><li><a class="tocitem" href="../vms/">Virtual Model Control of a Simulated Robot</a></li><li><a class="tocitem" href="../plotting/">Plotting with Makie.jl</a></li><li><a class="tocitem" href="../simulating/">Simulating with DifferentialEquations.jl</a></li><li><a class="tocitem" href="../control/">Virtual Model Control of a Real Robot using ROS</a></li><li><a class="tocitem" href="../optimization/">Optimization</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/franka_impedance_control/">Franka Impedance Control</a></li><li><a class="tocitem" href="../../examples/sciurus_reaching/">Sciurus reaching with obstacle avoidance</a></li><li><a class="tocitem" href="../../examples/compliant_path_following/">Franka compliant path following</a></li><li><a class="tocitem" href="../../examples/rail_robot/">Pendulum on a Bezier-Spline Rail</a></li></ul></li><li><a class="tocitem" href="../../api/api/">API</a></li><li><a class="tocitem" href="../../developer/developer/">Developer Notes</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Using a mechanism</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Using a mechanism</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Cambridge-Control-Lab/VMRobotControl.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/Cambridge-Control-Lab/VMRobotControl.jl/blob/main/docs/src/tutorials/using.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Using-a-Mechanism"><a class="docs-heading-anchor" href="#Using-a-Mechanism">Using a Mechanism</a><a id="Using-a-Mechanism-1"></a><a class="docs-heading-anchor-permalink" href="#Using-a-Mechanism" title="Permalink"></a></h1><h2 id="Compiling"><a class="docs-heading-anchor" href="#Compiling">Compiling</a><a id="Compiling-1"></a><a class="docs-heading-anchor-permalink" href="#Compiling" title="Permalink"></a></h2><p>The <a href="../../api/api/#VMRobotControl.Mechanism"><code>Mechanism</code></a> type is designed to be used for building the mechanism, not for performing fast computations.  Its internal data structures rely on Abstract types, which makes construction easier, but is  inherently type unstable. Once you have built your mechanism it can be &quot;compiled&quot; into a <a href="../../developer/developer/#VMRobotControl.CompiledMechanism"><code>CompiledMechanism</code></a>, which is fully type stable (see <a href="../../developer/developer/#TypeStableCollection"><code>TypeStableCollection</code></a> for more info on how this is achieved.).</p><p>First, we will load a mechanism: a 3 link robot defined by an RSON file.</p><pre><code class="language-julia hljs">using VMRobotControl
mechanism = parseRSON(&quot;../../../RSONs/rsons/simple3link.rson&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3DOF Mechanism{Float64} &quot;simple3link&quot; with 13 frames, 12 joints, 6 coordinates, 17 components</code></pre><p>Compiling a mechanism is as simple as </p><pre><code class="language-julia hljs">m = compile(mechanism)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">CompiledMechanism{Float64...}(simple3link)</code></pre><p>This returns the type-stable version of your mechanism. The compiled mechanism&#39;s type stable data structures can be accessed with fast indices, for example  let us consider the coordinate we added earlier for the link 3 centre of mass <code>&quot;L3_com&quot;</code>.</p><pre><code class="language-julia hljs">L3_com = get_compiled_coordID(m, &quot;L3_com&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">CompiledCoordID{FramePoint{Float64, CompiledFrameID}}(1, TypeStableIdx{CompiledCoord{FramePoint{Float64, CompiledFrameID}}}(3))</code></pre><p>This returns the <code>CompiledCoordID</code> for the coordinate. Note that <a href="../../developer/developer/#VMRobotControl.CompiledCoordID"><code>VMRobotControl.CompiledCoordID</code></a>  is a parametric type, so its type varies depending on the type of the coordinate. We can use this ID on the mechanism to get the compiled coordinate data:</p><pre><code class="language-julia hljs">m[L3_com]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">CompiledCoord{FramePoint{Float64, CompiledFrameID}}(FramePoint{Float64, CompiledFrameID}(CompiledFrameID(4), [0.0, 0.0, 0.5]), 9:11)</code></pre><p>In this case, the compiled coordinate data has replaced <code>String</code> frame ID &quot;L3_frame&quot; with the compiled frame ID of the compiled frame.</p><pre><code class="language-julia hljs">L3_frame_id = get_compiled_frameID(m, &quot;L3_frame&quot;)
L3_frame_id == m[L3_com].coord_data.frameID</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">true</code></pre><p>For the full API see <a href="../../api/api/#API">API</a></p><h2 id="Caches-and-&quot;Cache-Bundles&quot;"><a class="docs-heading-anchor" href="#Caches-and-&quot;Cache-Bundles&quot;">Caches and &quot;Cache-Bundles&quot;</a><a id="Caches-and-&quot;Cache-Bundles&quot;-1"></a><a class="docs-heading-anchor-permalink" href="#Caches-and-&quot;Cache-Bundles&quot;" title="Permalink"></a></h2><p>To use a mechanism to perform computations we need to create a cache for storing intermediate computations and results in. The cache and mechanism are normally needed together, so they are bundled together by default.</p><p>There are several functions for creating cache-bundles for different purposes:</p><table><tr><th style="text-align: left">Constructor</th><th style="text-align: left">Methods</th><th style="text-align: left">Description</th></tr><tr><td style="text-align: left"><a href="../../api/api/#VMRobotControl.new_kinematics_cache"><code>new_kinematics_cache</code></a></td><td style="text-align: left"><a href="../../api/api/#VMRobotControl.kinematics!"><code>kinematics!</code></a></td><td style="text-align: left">For transforms/coordinate configurations, used for plotting</td></tr><tr><td style="text-align: left"><a href="../../api/api/#VMRobotControl.new_jacobians_cache"><code>new_jacobians_cache</code></a></td><td style="text-align: left"><a href="../../api/api/#VMRobotControl.jacobians!"><code>jacobians!</code></a></td><td style="text-align: left">For kinematics and jacobians</td></tr><tr><td style="text-align: left"><a href="../../api/api/#VMRobotControl.new_rbstates_cache"><code>new_rbstates_cache</code></a></td><td style="text-align: left"><a href="../../api/api/#VMRobotControl.velocity_kinematics!"><code>velocity_kinematics!</code></a>, <a href="../../api/api/#VMRobotControl.acceleration_kinematics!"><code>acceleration_kinematics!</code></a></td><td style="text-align: left">For kinematics and velocities/velocity product accelerations (VPAs)</td></tr><tr><td style="text-align: left"><a href="../../api/api/#VMRobotControl.new_dynamics_cache"><code>new_dynamics_cache</code></a></td><td style="text-align: left"><a href="../../api/api/#VMRobotControl.velocity_kinematics!"><code>velocity_kinematics!</code></a>, <a href="../../api/api/#VMRobotControl.precompute!"><code>precompute!</code></a>, <a href="../../api/api/#VMRobotControl.inertance_matrix!"><code>inertance_matrix!</code></a>, <a href="../../api/api/#VMRobotControl.generalized_force!"><code>generalized_force!</code></a>, <a href="../../api/api/#VMRobotControl.dynamics!"><code>dynamics!</code></a></td><td style="text-align: left">For kinematics, velocities, VPAs, jacobians, and inertance matrices/generalized forces, used for simulating</td></tr><tr><td style="text-align: left"><a href="../../api/api/#VMRobotControl.new_control_cache"><code>new_control_cache</code></a></td><td style="text-align: left"><a href="../../api/api/#VMRobotControl.control_step!"><code>control_step!</code></a></td><td style="text-align: left">For realtime control with a virtual-mechanism-system</td></tr></table><p>For examples of using the kinematics cache for plotting skip to <a href="../plotting/#Plotting-with-Makie">Plotting with Makie</a>. For examples of using the dynamics cache for simulation skip to <a href="../simulating/#Simulating-with-DifferentialEquations.jl">Simulating with DifferentialEquations.jl</a>.</p><pre><code class="language-julia hljs">dcache = new_dynamics_cache(m)

t = 0.0
q = zero_q(m)
q̇ = zero_q̇(m)
g = VMRobotControl.DEFAULT_GRAVITY
u = zero_u(m)
dynamics!(dcache, t, q, q̇, g, u)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3-element Vector{Float64}:
 0.0
 0.0
 0.0</code></pre><h2 id="Accessing-results"><a class="docs-heading-anchor" href="#Accessing-results">Accessing results</a><a id="Accessing-results-1"></a><a class="docs-heading-anchor-permalink" href="#Accessing-results" title="Permalink"></a></h2><p>There are several functions for accessing results from a cache/bundle.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>The contents of a cache are NOT guaranteed to be initialized when it is created. Ensure you call the method needed to compute your results before accessing results from the cache.</p></div></div><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Note that some of these results are Vectors/Matrices from the cache, or other heap-allocated  objects, that will be updated when you use the cache again.  If you are using a result from the cache, and need to use the cache again, make sure to copy the results first!</p></div></div><p>As we have called <code>dynamics!</code>, the results in the cache are ready to view. Let&#39;s look at some of the computed values for the compiled frame ID from before.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; get_inertance_matrix(dcache)</code><code class="nohighlight hljs ansi" style="display:block;">3×3 Matrix{Float64}:
 8.75  4.5   1.25
 4.5   2.5   0.75
 1.25  0.75  0.25</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; get_generalized_force(dcache)</code><code class="nohighlight hljs ansi" style="display:block;">3-element Vector{Float64}:
 0.0
 0.0
 0.0</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; get_transform(dcache, L3_frame_id)</code><code class="nohighlight hljs ansi" style="display:block;">Transform{Float64}([0.0, 0.0, 2.0], Rotor{Float64}(1.0, [0.0, 0.0, 0.0]))</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; get_linear_vel(dcache, L3_frame_id)</code><code class="nohighlight hljs ansi" style="display:block;">3-element SVector{3, Float64} with indices SOneTo(3):
 0.0
 0.0
 0.0</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; get_angular_vel(dcache, L3_frame_id)</code><code class="nohighlight hljs ansi" style="display:block;">3-element SVector{3, Float64} with indices SOneTo(3):
 0.0
 0.0
 0.0</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; get_linear_vpa(dcache, L3_frame_id)</code><code class="nohighlight hljs ansi" style="display:block;">3-element SVector{3, Float64} with indices SOneTo(3):
 0.0
 0.0
 0.0</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; get_angular_vpa(dcache, L3_frame_id)</code><code class="nohighlight hljs ansi" style="display:block;">3-element SVector{3, Float64} with indices SOneTo(3):
 0.0
 0.0
 0.0</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; get_linear_jacobian(dcache, L3_frame_id)</code><code class="nohighlight hljs ansi" style="display:block;">3×3 view(::Array{Float64, 3}, 1:3, :, 4) with eltype Float64:
 2.0  1.0  0.0
 0.0  0.0  0.0
 0.0  0.0  0.0</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; get_angular_jacobian(dcache, L3_frame_id)</code><code class="nohighlight hljs ansi" style="display:block;">3×3 view(::Array{Float64, 3}, 4:6, :, 4) with eltype Float64:
 0.0  0.0  0.0
 1.0  1.0  1.0
 0.0  0.0  0.0</code></pre><p>However, more often than not you will instead use <em>coordinates</em> to access positions/velocities and jacobians of interest. </p><h2 id="Coordinate-computations"><a class="docs-heading-anchor" href="#Coordinate-computations">Coordinate computations</a><a id="Coordinate-computations-1"></a><a class="docs-heading-anchor-permalink" href="#Coordinate-computations" title="Permalink"></a></h2><p>There are four functions to access computation results for coordinates: <code>configuration</code>, <code>velocity</code>, <code>vpa</code>, and <code>jacobian</code>.  As before, you must make sure the cache is populated with results before calling these functions, and copy the result elsewhere if you are then going to use the cache again.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; configuration(dcache, L3_com)</code><code class="nohighlight hljs ansi" style="display:block;">3-element SVector{3, Float64} with indices SOneTo(3):
 0.0
 0.0
 2.5</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; velocity(dcache, L3_com)</code><code class="nohighlight hljs ansi" style="display:block;">3-element SVector{3, Float64} with indices SOneTo(3):
 0.0
 0.0
 0.0</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; vpa(dcache, L3_com)</code><code class="nohighlight hljs ansi" style="display:block;">3-element SVector{3, Float64} with indices SOneTo(3):
 0.0
 0.0
 0.0</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; jacobian(dcache, L3_com)</code><code class="nohighlight hljs ansi" style="display:block;">3×3 view(::Matrix{Float64}, 9:11, :) with eltype Float64:
 2.5  1.5  0.5
 0.0  0.0  0.0
 0.0  0.0  0.0</code></pre><p>Configuration is dependent only on the time and joint state <code>q</code>, so can also be used with the kinematics cache.</p><h2 id="Component-computations"><a class="docs-heading-anchor" href="#Component-computations">Component computations</a><a id="Component-computations-1"></a><a class="docs-heading-anchor-permalink" href="#Component-computations" title="Permalink"></a></h2><p>TODO</p><h2 id="Modifying-a-compiled-mechanism"><a class="docs-heading-anchor" href="#Modifying-a-compiled-mechanism">Modifying a compiled mechanism</a><a id="Modifying-a-compiled-mechanism-1"></a><a class="docs-heading-anchor-permalink" href="#Modifying-a-compiled-mechanism" title="Permalink"></a></h2><p>A compiled mechanism <em>can</em> be modified using <code>Base.setindex!</code>, by modifying its joints/coordinates/components, only if the  type of the joint/component does not change.  This is made simpler by using the <code>remake</code> function which allows you to easily remake a compiled joint/coordinate/component and modify one or more of its fields using keyword arguments. The interface to do so is like so:</p><pre><code class="nohighlight hljs">using VMRobotControl: remake
m[ee_com] = remake(m[ee_com]; point=SVector(0.3*z))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../building/">« Building a mechanism</a><a class="docs-footer-nextpage" href="../vms/">Virtual Model Control of a Simulated Robot »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Thursday 30 January 2025 16:30">Thursday 30 January 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
