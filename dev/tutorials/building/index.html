<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Building a mechanism · VMRobotControl.jl</title><meta name="title" content="Building a mechanism · VMRobotControl.jl"/><meta property="og:title" content="Building a mechanism · VMRobotControl.jl"/><meta property="twitter:title" content="Building a mechanism · VMRobotControl.jl"/><meta name="description" content="Documentation for VMRobotControl.jl."/><meta property="og:description" content="Documentation for VMRobotControl.jl."/><meta property="twitter:description" content="Documentation for VMRobotControl.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">VMRobotControl.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../introduction/">Introduction</a></li><li class="is-active"><a class="tocitem" href>Building a mechanism</a><ul class="internal"><li><a class="tocitem" href="#Adding-rigid-body-frames-and-joints"><span>Adding rigid body frames and joints</span></a></li><li><a class="tocitem" href="#Adding-mass,-inertia,-and-damping"><span>Adding mass, inertia, and damping</span></a></li><li><a class="tocitem" href="#Gravity-compensation"><span>Gravity compensation</span></a></li><li><a class="tocitem" href="#End-effector-impedance-control"><span>End effector impedance control</span></a></li></ul></li><li><a class="tocitem" href="../using/">Using a mechanism</a></li><li><a class="tocitem" href="../vms/">Virtual Model Control of a Simulated Robot</a></li><li><a class="tocitem" href="../plotting/">Plotting with Makie.jl</a></li><li><a class="tocitem" href="../simulating/">Simulating with DifferentialEquations.jl</a></li><li><a class="tocitem" href="../control/">Virtual Model Control of a Real Robot using ROS</a></li><li><a class="tocitem" href="../optimization/">Optimization</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/franka_impedance_control/">Franka Impedance Control</a></li><li><a class="tocitem" href="../../examples/sciurus_reaching/">Sciurus reaching with obstacle avoidance</a></li><li><a class="tocitem" href="../../examples/compliant_path_following/">Franka compliant path following</a></li><li><a class="tocitem" href="../../examples/rail_robot/">Pendulum on a Bezier-Spline Rail</a></li></ul></li><li><a class="tocitem" href="../../api/api/">API</a></li><li><a class="tocitem" href="../../developer/developer/">Developer Notes</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Building a mechanism</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Building a mechanism</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Cambridge-Control-Lab/VMRobotControl.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/Cambridge-Control-Lab/VMRobotControl.jl/blob/main/docs/src/tutorials/building.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Building-a-Mechanism"><a class="docs-heading-anchor" href="#Building-a-Mechanism">Building a Mechanism</a><a id="Building-a-Mechanism-1"></a><a class="docs-heading-anchor-permalink" href="#Building-a-Mechanism" title="Permalink"></a></h1><p>Let&#39;s build a model robot: a 3DOF arm on a 2DOF sliding table, using 2 prismatic joints followed by 2 revolute joints.</p><p>We will supplement this intro with pictures/videos, but not present the plotting code here. To learn more about plotting, you may read the section <a href="../plotting/#Plotting-with-Makie">Plotting with Makie</a>.</p><pre><code class="language-julia hljs">using VMRobotControl
using StaticArrays
using LinearAlgebra</code></pre><p>To begin we make the mechanism and use <a href="../../api/api/#VMRobotControl.add_frame!"><code>add_frame!</code></a> to add the named rigid-body-frames that we will use. All the frames must be joined in a tree from the root frame of the mechanism  which is called <code>&quot;root_frame&quot;</code>:</p><pre><code class="language-julia hljs">mechanism = Mechanism{Float64}(&quot;TableArmRobot&quot;)
F0 = root_frame(mechanism)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">&quot;root_frame&quot;</code></pre><h2 id="Adding-rigid-body-frames-and-joints"><a class="docs-heading-anchor" href="#Adding-rigid-body-frames-and-joints">Adding rigid body frames and joints</a><a id="Adding-rigid-body-frames-and-joints-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-rigid-body-frames-and-joints" title="Permalink"></a></h2><p>Lets add our named frames. Note that <code>add_frame!</code> returns the name of the frame (as a string) for convenience.</p><pre><code class="language-julia hljs">F1 = add_frame!(mechanism; id=&quot;L1_frame&quot;)
F2 = add_frame!(mechanism; id=&quot;L2_frame&quot;)
F3 = add_frame!(mechanism; id=&quot;L3_frame&quot;)
F4 = add_frame!(mechanism; id=&quot;L4_frame&quot;)
F5 = add_frame!(mechanism; id=&quot;L5_frame&quot;)
F_EE = add_frame!(mechanism; id=&quot;EE_frame&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">&quot;EE_frame&quot;</code></pre><p>Now: how do we define the joints that join these frames together? First we must define the joint data. The form of the joint data depends on the type of joint: a <a href="../../api/api/#VMRobotControl.Rigid"><code>Rigid</code></a> joint needs a [<code>Transform</code>] whereas a <a href="../../api/api/#VMRobotControl.Revolute"><code>Revolute</code></a> or <a href="../../api/api/#VMRobotControl.Prismatic"><code>Prismatic</code></a>  joint requires the axis of rotation/translation (and optionally a transform too!). This is not a minimal representation (such as denavit hartenburg) but it is a  flexible representation.</p><pre><code class="language-julia hljs"># Define the unit vectors to make things easier
X = SVector(1., 0., 0.)
Y = SVector(0., 1., 0.)
Z = SVector(0., 0., 1.)

# First two prismatic joints, one in the X, direction, one in Y
J1 = Prismatic(X)
J2 = Prismatic(Y)
# Then a simple articulated arm: J3 rotates around Z, J4 is the shoulder,
# and J5 the elbow.
J3 = Revolute(Z)
J4 = Revolute(X)
J5 = Revolute(X, Transform(0.4*Z))
# Transform(::SVector{3}) is a translation, so J5 is 40cm above J4.

# Finally define a rigid joint that will connect the elbow to end-effector
# frame, again 40cm above J5
J_EE = Rigid(Transform(0.4*Z))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Rigid{Float64}(Transform{Float64}([0.0, 0.0, 0.4], Rotor{Float64}(1.0, [0.0, 0.0, 0.0])))</code></pre><p>Now that we have defined the joints, we must add them to the mechanism by  specifying which frames they each connect, and giving each joint an ID (a name), using <code>add_joint!</code>.</p><pre><code class="language-julia hljs">add_joint!(mechanism, J1; parent=F0, child=F1, id=&quot;J1&quot;)
add_joint!(mechanism, J2; parent=F1, child=F2, id=&quot;J2&quot;)
add_joint!(mechanism, J3; parent=F2, child=F3, id=&quot;J3&quot;)
add_joint!(mechanism, J4; parent=F3, child=F4, id=&quot;J4&quot;)
add_joint!(mechanism, J5; parent=F4, child=F5, id=&quot;J5&quot;)
add_joint!(mechanism, J_EE; parent=F5, child=F_EE, id=&quot;J_EE&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">&quot;J_EE&quot;</code></pre><p>Let&#39;s inspect our mechanism now:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; mechanism</code><code class="nohighlight hljs ansi" style="display:block;">5DOF Mechanism{Float64} &quot;TableArmRobot&quot; with 7 frames, 6 joints</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; frames(mechanism)</code><code class="nohighlight hljs ansi" style="display:block;">7-element Vector{String}:
 &quot;root_frame&quot;
 &quot;L1_frame&quot;
 &quot;L2_frame&quot;
 &quot;L3_frame&quot;
 &quot;L4_frame&quot;
 &quot;L5_frame&quot;
 &quot;EE_frame&quot;</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; joints(mechanism)</code><code class="nohighlight hljs ansi" style="display:block;">OrderedCollections.OrderedDict{String, VMRobotControl.MechanismJoint{&lt;:VMRobotControl.AbstractJointData{Float64}, String}} with 6 entries:
  &quot;J1&quot;   =&gt; MechanismJoint{PrismaticData{Float64}, String}(PrismaticData{Float6…
  &quot;J2&quot;   =&gt; MechanismJoint{PrismaticData{Float64}, String}(PrismaticData{Float6…
  &quot;J3&quot;   =&gt; MechanismJoint{RevoluteData{Float64}, String}(RevoluteData{Float64}…
  &quot;J4&quot;   =&gt; MechanismJoint{RevoluteData{Float64}, String}(RevoluteData{Float64}…
  &quot;J5&quot;   =&gt; MechanismJoint{RevoluteData{Float64}, String}(RevoluteData{Float64}…
  &quot;J_EE&quot; =&gt; MechanismJoint{Rigid{Float64}, String}(Rigid{Float64}(Transform{Flo…</code></pre><h2 id="Adding-mass,-inertia,-and-damping"><a class="docs-heading-anchor" href="#Adding-mass,-inertia,-and-damping">Adding mass, inertia, and damping</a><a id="Adding-mass,-inertia,-and-damping-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-mass,-inertia,-and-damping" title="Permalink"></a></h2><p>Now, the rigid body tree of our robot is defined.  However to do simulations we need to give it some mass and inertia. Mass, inertia, damping and other dynamic effects are achieved by adding <em>components</em> to the mechanism. These are generally added using the function <code>add_component!</code>, but there are  some special helper functions like <a href="../../api/api/#VMRobotControl.add_inertia!"><code>add_inertia!</code></a>, to help in certain cases.</p><p>Point masses are defined by their mass, and a coordinate.  The coordinate should represent the centre of mass, in the root frame of the mechanism. To do this we use the <a href="../../api/api/#VMRobotControl.FrameOrigin"><code>FrameOrigin</code></a> and <a href="../../api/api/#VMRobotControl.FramePoint"><code>FramePoint</code></a> coordinate types. The <code>configuration</code> of a <code>FrameOrigin</code> coordinate is the position of the origin of a frame,  represented in the root frame. The <code>configuration</code> of a <code>FramePoint</code> coordinate is the position of a point in a frame, represented in the root frame.</p><pre><code class="language-julia hljs">add_coordinate!(mechanism, FrameOrigin(F2); id=&quot;base_centre_of_mass&quot;)
add_coordinate!(mechanism, FrameOrigin(F5); id=&quot;elbow_centre_of_mass&quot;)
add_coordinate!(mechanism, FramePoint(F_EE, 0.2*Z); id=&quot;ee_centre_of_mass&quot;)

add_component!(mechanism, PointMass(10.0, &quot;base_centre_of_mass&quot;); id=&quot;base_mass&quot;)
add_component!(mechanism, PointMass(2.0, &quot;elbow_centre_of_mass&quot;); id=&quot;lower_arm_mass&quot;)
add_component!(mechanism, PointMass(1.0, &quot;ee_centre_of_mass&quot;); id=&quot;ee_mass&quot;)

I_mat = @SMatrix [
    0.01  0.    0.  ;
    0.    0.01  0.  ;
    0.    0.    0.01
]
add_inertia!(mechanism, F3, I_mat; id=&quot;L3_inertia&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">5DOF Mechanism{Float64} &quot;TableArmRobot&quot; with 7 frames, 6 joints, 4 coordinates, 4 components</code></pre><p>If there are insufficient point masses/inertias the robot inertance matrix will be singular, and you will not be able to solve the dynamics. This happens because at least one of the joints can accelerate without a  point mass or inertia accelerating, so the computed acceleration of the joint would be infinite.</p><p><video src="../building1.mp4" controls="true" title><a href="../building1.mp4"></a></video></p><p>We will now also add some damping to each joint, otherwise our system is undamped and will never settle. For this we use the <code>JointSubspace</code> coordinate type to define a coordinate for each joint. The <code>configuration</code> of the <code>JointSubspace</code> coordinate is the extension of a prismatic joint, or the angle of a revolute joint.</p><p>Then we add a <code>LinearDamper</code> using each <code>JointSubspace</code> coordinate, so that we have linear damping acting on each joint.</p><pre><code class="language-julia hljs">for i = 1:5
    add_coordinate!(mechanism, JointSubspace(&quot;J$i&quot;); id=&quot;J$i&quot;)
    add_component!(mechanism, LinearDamper(0.5, &quot;J$i&quot;); id=&quot;J$(i)_damper&quot;)
end</code></pre><p><video src="../building2.mp4" controls="true" title><a href="../building2.mp4"></a></video></p><h2 id="Gravity-compensation"><a class="docs-heading-anchor" href="#Gravity-compensation">Gravity compensation</a><a id="Gravity-compensation-1"></a><a class="docs-heading-anchor-permalink" href="#Gravity-compensation" title="Permalink"></a></h2><p>First we will add gravity compensation. Gravity compensation works by applying a constant force equal to the weight of each link at its centre of mass. This is made easy by the  <a href="../../api/api/#VMRobotControl.GravityCompensator"><code>GravityCompensator</code></a> component, and the <a href="../../api/api/#VMRobotControl.add_gravity_compensation!"><code>add_gravity_compensation!</code></a>.</p><pre><code class="language-julia hljs">add_gravity_compensation!(mechanism, VMRobotControl.DEFAULT_GRAVITY)</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>For gravity compensation, you should typically add the component to the virtual mechanism system, as when using <code>control_step!</code>, all components on the <em>robot</em> are treated as part of the robot model, not part of the controller, so forces due to them are not applied by the controller. </p></div></div><p><video src="../building3.mp4" controls="true" title><a href="../building3.mp4"></a></video></p><h2 id="End-effector-impedance-control"><a class="docs-heading-anchor" href="#End-effector-impedance-control">End effector impedance control</a><a id="End-effector-impedance-control-1"></a><a class="docs-heading-anchor-permalink" href="#End-effector-impedance-control" title="Permalink"></a></h2><p>Finally we will add a linear spring and damper between the end-effector and a reference position. First we define a coordinate for the end-effector position</p><pre><code class="language-julia hljs">refpos = -0.5*X + -0.5*Y + 0.5*Z
add_coordinate!(mechanism, FrameOrigin(F_EE); id=&quot;ee_position&quot;)
add_coordinate!(mechanism, ConstCoord(refpos); id=&quot;ref&quot;)
add_coordinate!(mechanism, CoordDifference(&quot;ee_position&quot;, &quot;ref&quot;); id=&quot;ee_error&quot;)

ee_stiffness = SMatrix{3, 3}(100.0, 0.0, 0.0, 0.0, 100.0, 0.0, 0.0, 0.0, 100.0)
ee_damping = SMatrix{3, 3}(5.0, 0.0, 0.0, 0.0, 5.0, 0.0, 0.0, 0.0, 5.0)

add_component!(mechanism, LinearSpring(ee_stiffness, &quot;ee_error&quot;); id=&quot;ee_spring&quot;)
add_component!(mechanism, LinearDamper(ee_damping, &quot;ee_error&quot;); id=&quot;ee_damper&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">&quot;ee_damper&quot;</code></pre><p>Note that the same <code>LinearDamper</code> type is used here as for the joint damping. This is because the  coordinate system handles all the geometry! As long as the damping coefficient can multiply the  velocity, the <code>LinearDamper</code> will work, so we can use a 3x3 matrix as shown here, or a scalar as done for joint damping.</p><p><video src="../building4.mp4" controls="true" title><a href="../building4.mp4"></a></video></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../introduction/">« Introduction</a><a class="docs-footer-nextpage" href="../using/">Using a mechanism »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Thursday 16 January 2025 16:43">Thursday 16 January 2025</span>. Using Julia version 1.11.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
